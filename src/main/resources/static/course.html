<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Details | EduSmart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5faff; font-family: 'Segoe UI', sans-serif; }
        .lecture-list li, .student-list li, .professor-list li, .file-list li {
            background: #fff; margin-bottom: 8px; border-radius: 8px; padding: 10px;
        }
        .action-section { margin-top: 30px; }
        .action-section input[type="file"] { max-width: 300px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 id="course-title" class="text-primary mb-4"></h1>
    <p id="course-description" class="lead"></p>

    <h4 class="mt-4">Lectures</h4>
    <ul id="lecture-list" class="list-group lecture-list mb-4"></ul>

    <h4 class="mt-4">Students</h4>
    <ul id="student-list" class="list-group student-list mb-4"></ul>

    <h4 class="mt-4">Professors</h4>
    <ul id="professor-list" class="list-group professor-list mb-4"></ul>

    <h4 class="mt-4">Files</h4>
    <ul id="file-list" class="list-group file-list mb-4"></ul>

    <div class="action-section" id="action-buttons"></div>
</div>

<script src="js/api.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const title = params.get("title");
        if (!title) {
            document.body.innerHTML = `<div class="text-center text-danger mt-5">Invalid course.</div>`;
            return;
        }

        const currentUser = getCurrentUser();
        const role = currentUser?.role;
        const userId = currentUser?.id;

        try {
            // COURSE DETAILS
            const course = await apiFetch(`/getCourseByTitle?title=${encodeURIComponent(title)}`);
            if (!course) throw new Error("Course not found");

            const courseId = course?.id;
            if (!courseId) throw new Error("Course ID not found");

            document.getElementById("course-title").textContent = course.title;
            document.getElementById("course-description").textContent = course.description || "No description available.";

            // LECTURES
            const lectures = course.lectionList || [];
            const lectureListEl = document.getElementById("lecture-list");
            if (lectures.length === 0) {
                lectureListEl.innerHTML = `<li class='list-group-item text-muted'>No lectures yet.</li>`;
            } else {
                lectureListEl.innerHTML = lectures.map((l, index) => `
                <li class='list-group-item'>
                    <a href="lecture.html?title=${encodeURIComponent(title)}&index=${index + 1}" class="text-decoration-none text-primary">
                        Lecture ${index + 1}: ${l}
                    </a>
                </li>
            `).join("");
            }

            // STUDENTS
            const students = await apiFetch(`/getStudentsByCourseTitle?title=${encodeURIComponent(title)}`);
            document.getElementById("student-list").innerHTML = students?.length
                ? students.map(s => `<li class='list-group-item'>${s.firstName} ${s.lastName} (${s.email})</li>`).join("")
                : `<li class='list-group-item text-muted'>No students enrolled.</li>`;

            // PROFESSORS
            const professor = await apiFetch(`/getProfessorByCourseTitle?title=${encodeURIComponent(title)}`);
            const professorListEl = document.getElementById("professor-list");

            if (professor && professor.firstName) {
                professorListEl.innerHTML = `<li class='list-group-item'>${professor.firstName} ${professor.lastName} (${professor.email})</li>`;
            } else {
                // No professor assigned message
                professorListEl.innerHTML = `<li class='list-group-item text-muted'>No professor assigned.</li>`;

                // Show "Assign Professor" button only if current user is a professor
                if (role === "PROFESSOR") {
                    const actionsDiv = document.getElementById("action-buttons");

                    const assignBtn = document.createElement("button");
                    assignBtn.className = "btn btn-primary me-2";
                    assignBtn.textContent = "Assign Professor";

                    const assignMsg = document.createElement("div");
                    assignMsg.className = "mt-2";

                    assignBtn.addEventListener("click", async () => {
                        assignBtn.disabled = true;
                        try {
                            const res = await fetch(`/api/professor/assignProfOnCourse/${userId}/${encodeURIComponent(title)}`, {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                            });
                            const msg = await res.text();
                            assignMsg.textContent = res.ok ? `✅ ${msg}` : `❌ ${msg}`;
                            assignMsg.className = res.ok ? "text-success mt-2" : "text-danger mt-2";
                            if (res.ok) assignBtn.remove();
                        } catch (err) {
                            console.error("Assign professor error:", err);
                            assignMsg.textContent = "❌ Network or server error.";
                            assignMsg.className = "text-danger mt-2";
                            assignBtn.disabled = false;
                        }
                    });

                    actionsDiv.appendChild(assignBtn);
                    actionsDiv.appendChild(assignMsg);
                }
            }



            // FILES
            const files = await apiFetch(`/getFilesByCourseTitle?title=${encodeURIComponent(title)}`);
            const fileListEl = document.getElementById("file-list");
            if (files?.length) {
                fileListEl.innerHTML = files.map(f => `
                <li class='list-group-item'>
                    <a href="/api/files/download/${f.id}" target="_blank">${f.fileName}</a>
                </li>
            `).join("");
            } else {
                fileListEl.innerHTML = `<li class='list-group-item text-muted'>No files uploaded.</li>`;
            }

            // ACTION BUTTONS
            const actionsDiv = document.getElementById("action-buttons");

            // STUDENT: Enroll button (only if not enrolled)
            if (role === "STUDENT") {
                const enrolledRes = await fetch(`/api/student/isEnrolledOnCourse/${userId}/${courseId}`, {
                    headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                });
                const isEnrolled = enrolledRes.ok ? await enrolledRes.json() : false;

                if (!isEnrolled) {
                    const enrollBtn = document.createElement("button");
                    enrollBtn.className = "btn btn-success me-2";
                    enrollBtn.textContent = "Enroll in Course";

                    const enrollMsg = document.createElement("div");
                    enrollMsg.className = "mt-2";

                    enrollBtn.addEventListener("click", async () => {
                        enrollBtn.disabled = true;
                        try {
                            const res = await fetch(`/api/student/enrollStudentOnCourse/${userId}/${encodeURIComponent(title)}`, {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                            });
                            const msg = await res.text();
                            enrollMsg.textContent = res.ok ? `✅ ${msg}` : `❌ ${msg}`;
                            enrollMsg.className = res.ok ? "text-success mt-2" : "text-danger mt-2";
                            if (res.ok) enrollBtn.remove();
                        } catch (err) {
                            console.error("Enrollment error:", err);
                            enrollMsg.textContent = "❌ Network or server error.";
                            enrollMsg.className = "text-danger mt-2";
                            enrollBtn.disabled = false;
                        }
                    });

                    actionsDiv.appendChild(enrollBtn);
                    actionsDiv.appendChild(enrollMsg);
                }
            }


            // ALL ROLES: File upload
            if (["STUDENT","PROFESSOR","ADMIN"].includes(role)) {
                const fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.className = "form-control my-2";

                const uploadBtn = document.createElement("button");
                uploadBtn.className = "btn btn-warning me-2";
                uploadBtn.textContent = "Upload File";

                const uploadMsg = document.createElement("div");
                uploadMsg.className = "mt-2";

                uploadBtn.addEventListener("click", async () => {
                    if (!fileInput.files.length) return alert("Select a file to upload");
                    const formData = new FormData();
                    formData.append("file", fileInput.files[0]);

                    try {
                        const res = await fetch(`/api/files/upload/${encodeURIComponent(title)}`, {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` },
                            body: formData
                        });
                        const msg = await res.text();
                        uploadMsg.textContent = res.ok ? `✅ ${msg}` : `❌ ${msg}`;
                        uploadMsg.className = res.ok ? "text-success mt-2" : "text-danger mt-2";
                    } catch (err) {
                        console.error(err);
                        uploadMsg.textContent = "❌ Network or server error.";
                        uploadMsg.className = "text-danger mt-2";
                    }
                });

                actionsDiv.appendChild(fileInput);
                actionsDiv.appendChild(uploadBtn);
                actionsDiv.appendChild(uploadMsg);
            }

        } catch(err) {
            console.error(err);
            document.body.innerHTML = `<div class="text-center text-danger mt-5">Failed to load course details.</div>`;
        }
    });
</script>

</body>
</html>
