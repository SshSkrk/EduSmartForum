<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>EduSmart Admin Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body { background-color: #f5faff; font-family: 'Segoe UI', sans-serif; }
        .navbar { background-color: #e3f2fd !important; }
        .card:hover { transform: translateY(-5px); transition: 0.3s; }
        .section { margin-top: 2rem; padding: 1.5rem; background-color: #fff; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { color: #0077b6; margin-bottom: 1rem; }
        table th, table td { vertical-align: middle; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light px-4">
    <div class="container-fluid">
        <div class="collapse navbar-collapse" id="navbar-links">
            <div class="ms-auto">
                <a href="index.html" class="btn btn-outline-primary me-2">Home</a>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- Dashboard Header -->
    <div class="section text-center">
        <h1>Welcome, Admin!</h1>
        <p>Manage users, courses, and student submissions.</p>
    </div>

    <!-- Create New User -->
    <div class="section" id="create-user-section">
        <h2>Create New User</h2>
        <form id="create-user-form" class="row g-3">
            <div class="col-md-3"><input type="text" class="form-control" id="firstName" placeholder="First Name" required></div>
            <div class="col-md-3"><input type="text" class="form-control" id="lastName" placeholder="Last Name" required></div>
            <div class="col-md-3"><input type="email" class="form-control" id="email" placeholder="Email" required></div>
            <div class="col-md-2"><input type="password" class="form-control" id="password" placeholder="Password" required></div>
            <div class="col-md-1">
                <select class="form-select" id="role" required>
                    <option value="ADMIN">Admin</option>
                    <option value="PROFESSOR">Professor</option>
                    <option value="STUDENT">Student</option>
                </select>
            </div>
            <div class="col-12"><button type="submit" class="btn btn-primary">Create User</button></div>
        </form>
        <div id="create-user-message" class="mt-2"></div>
    </div>

    <!-- All Users Table -->
    <div class="section" id="all-users-section">
        <h2>All Users</h2>
        <table class="table table-hover" id="users-table">
            <thead class="table-light">
            <tr>
                <th>#</th><th>Email</th><th>First Name</th><th>Last Name</th><th>Role</th><th>Verified</th><th>Actions</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Create Course Form -->
    <div class="section" id="create-course-section">
        <h2>Create New Course</h2>
        <form id="create-course-form">
            <div class="mb-3"><input type="text" class="form-control" id="courseTitle" placeholder="Course Title" required></div>
            <div class="mb-3"><textarea class="form-control" id="courseDescription" placeholder="Description"></textarea></div>
            <div class="mb-3"><input type="text" class="form-control" id="lectionList" placeholder="Lections (comma separated)"></div>
            <button type="submit" class="btn btn-success">Create Course</button>
        </form>
        <div id="create-course-message" class="mt-2"></div>
    </div>

    <!-- All Courses Table -->
    <div class="section" id="all-courses-section">
        <h2>All Courses</h2>
        <button id="load-courses" class="btn btn-info mb-3">Load Courses</button>
        <table class="table table-hover" id="courses-table">
            <thead class="table-light">
            <tr>
                <th>ID</th><th>Title</th><th>Professor ID</th><th>Student IDs</th><th>Lections</th><th>Description</th><th>Actions</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- View Submissions -->
    <div class="section" id="view-submissions-section">
        <h2>Student Quiz Submissions</h2>
        <button id="load-submissions" class="btn btn-warning mb-3">Load Submissions</button>
        <table class="table table-hover" id="submissions-table">
            <thead class="table-light">
            <tr>
                <th>ID</th><th>Student ID</th><th>Quiz Title</th><th>Score</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<script>
    const token = localStorage.getItem("token");

    // ===== Admin Access Check =====
    async function ensureAdminAccess() {
        if (!token) return window.location.href = "login.html";
        try {
            const res = await fetch("/api/current-user", { headers: { "Authorization": `Bearer ${token}` }});
            if (!res.ok) throw new Error("Unauthorized");
            const user = await res.json();
            if (user.role.toUpperCase() !== "ADMIN") {
                alert("Access denied. Admins only.");
                window.location.href = "index.html";
            }
        } catch(err) {
            console.error(err);
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }
    }

    // ===== Logout =====
    function logout() { localStorage.removeItem("token"); window.location.href = "login.html"; }

    // ===== Create User =====
    document.getElementById("create-user-form").addEventListener("submit", async e => {
        e.preventDefault();
        const user = {
            firstName: document.getElementById("firstName").value,
            lastName: document.getElementById("lastName").value,
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
            role: document.getElementById("role").value
        };
        try {
            const res = await fetch("/api/admin/createPerson", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify(user)
            });
            const msgDiv = document.getElementById("create-user-message");
            if (res.ok) {
                msgDiv.innerHTML = `<span class="text-success">User created successfully!</span>`;
                e.target.reset();
                loadAllUsers();
            } else {
                const text = await res.text();
                msgDiv.innerHTML = `<span class="text-danger">${text}</span>`;
            }
        } catch(err){ console.error(err); }
    });

    // ===== Load Users =====
    async function loadAllUsers() {
        try {
            const res = await fetch("/api/admin/getAllPersonList", { headers: { "Authorization": `Bearer ${token}` }});
            if (!res.ok) throw new Error();
            const users = await res.json();
            const tbody = document.querySelector("#users-table tbody");
            tbody.innerHTML = "";
            users.forEach((user,index)=> {
                tbody.innerHTML += `<tr data-email="${user.email}">
                <td>${index+1}</td>
                <td>${user.email}</td>
                <td>${user.firstName}</td>
                <td>${user.lastName}</td>
                <td>${user.role}</td>
                <td>${user.verified ? "Yes" : "No"}</td>
                <td><button class="btn btn-sm btn-danger delete-user-btn">Delete</button></td>
            </tr>`;
            });
        } catch(err){ console.error(err); }
    }

    // ===== Delete User =====
    async function deleteUser(email) {
        if(!confirm(`Delete ${email}?`)) return;
        try{
            const res = await fetch(`/api/admin/deletePerson/${email}`, { method:"DELETE", headers:{ "Authorization":`Bearer ${token}` }});
            if(res.ok){
                alert("Deleted");
                loadAllUsers();
            } else alert("Failed");
        }catch(err){ console.error(err); }
    }

    // ===== Event Delegation for User Deletion =====
    document.querySelector("#users-table tbody").addEventListener("click", e => {
        if (e.target.classList.contains("delete-user-btn")) {
            const email = e.target.closest("tr").dataset.email;
            deleteUser(email);
        }
    });

    // ===== Create Course =====
    document.getElementById("create-course-form").addEventListener("submit", async e => {
        e.preventDefault();
        const dto = {
            title: document.getElementById("courseTitle").value,
            description: document.getElementById("courseDescription").value,
            lectionList: document.getElementById("lectionList").value.split(",").map(s => s.trim())
        };
        try {
            const res = await fetch("/api/admin/createCourse", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify(dto)
            });
            const msgDiv = document.getElementById("create-course-message");
            if (res.ok) {
                msgDiv.innerHTML = `<span class="text-success">Course created!</span>`;
                e.target.reset();
                loadAllCourses();
            } else {
                const text = await res.text();
                msgDiv.innerHTML = `<span class="text-danger">${text}</span>`;
            }
        } catch (err) { console.error(err); }
    });

    // ===== Load Courses =====
    async function loadAllCourses() {
        try {
            const res = await fetch("/api/getAllCourses", { headers: { "Authorization": `Bearer ${token}` }});
            if (!res.ok) throw new Error("Failed to fetch courses");
            const courses = await res.json();
            const tbody = document.querySelector("#courses-table tbody");
            tbody.innerHTML = "";
            courses.forEach(c => {
                tbody.innerHTML += `
        <tr>
            <td>${c.id}</td>
            <td>${c.title}</td>
            <td>${c.professorId || ""}</td>
            <td>${c.studentIDs?.join(",") || ""}</td>
            <td>${c.lectionList?.join(",") || ""}</td>
            <td>${c.description || ""}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteCourse('${c.title}')">Delete</button>
            </td>
        </tr>`;
            });
        } catch (err) {
            console.error(err);
            alert("Failed to load courses");
        }
    }

    // ===== Delete Course =====
    async function deleteCourse(title) {
        if (!confirm(`Delete course "${title}"?`)) return;

        try {
            const res = await fetch(`/api/admin/deleteCourse/${encodeURIComponent(title)}`, {
                method: "DELETE",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            if (!res.ok) throw new Error("Failed to delete course");
            alert("Course deleted successfully!");
            loadAllCourses();
        } catch (err) {
            console.error(err);
            alert("Failed to delete course");
        }
    }



    // ===== Event Delegation for Course Deletion =====
    document.querySelector("#courses-table tbody").addEventListener("click", e => {
        if (e.target.classList.contains("delete-course-btn")) {
            const courseId = e.target.closest("tr").dataset.id;
            deleteCourse(courseId);
        }
    });

    // ===== Load Submissions =====
    document.getElementById("load-submissions").addEventListener("click", async ()=> {
        try {
            const res = await fetch("/api/getAllSubmissions", { headers:{ "Authorization":`Bearer ${token}` }});
            if(!res.ok) throw new Error();
            const subs = await res.json();
            const tbody = document.querySelector("#submissions-table tbody");
            tbody.innerHTML="";
            subs.forEach(s=>{
                tbody.innerHTML += `<tr>
                <td>${s.id}</td><td>${s.studentId}</td><td>${s.quizTitle}</td><td>${s.score}</td>
            </tr>`;
            });
        } catch(err){ console.error(err); alert("Failed to load submissions"); }
    });

    // ===== Button to reload courses manually =====
    document.getElementById("load-courses").addEventListener("click", loadAllCourses);

    // ===== Run on page load =====
    ensureAdminAccess();
    loadAllUsers();
    loadAllCourses();

</script>
</body>
</html>
