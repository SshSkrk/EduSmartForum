<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile ‚Äì Campus Event Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f5faff;
            font-family: 'Segoe UI', sans-serif;
        }
        .container {
            max-width: 700px;
            margin-top: 40px;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-top: 10px;
        }
        .password-toggle {
            cursor: pointer;
            user-select: none;
        }
        .navbar {
            background-color: #e3f2fd !important;
        }
    </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-light bg-light justify-content-end px-4">
    <div>
        <a href="index.html" class="btn btn-outline-secondary me-2">Home</a>
    </div>
</nav>

<div class="container">
    <h2 class="mb-4">üë§ Your Profile</h2>
    <form id="profileForm">
        <label class="form-label" for="email">Email (cannot be changed)</label>
        <input type="email" class="form-control" id="email" readonly />

        <div class="mb-3 mt-2" id="verificationContainer"></div>

        <label class="form-label" for="role">Role (cannot be changed)</label>
        <input type="text" class="form-control" id="role" readonly />

        <label class="form-label" for="firstName">First Name</label>
        <input type="text" class="form-control" id="firstName" required />

        <label class="form-label" for="lastName">Last Name</label>
        <input type="text" class="form-control" id="lastName" required />

        <label class="form-label" for="password">Password</label>
        <div class="input-group">
            <input type="password" class="form-control" id="password" placeholder="Leave blank to keep current password" />
            <button class="btn btn-outline-secondary password-toggle" type="button" id="togglePassword" tabindex="-1">
                üëÅÔ∏è
            </button>
        </div>
        <div id="updateMessage" class="mt-3"></div>
    </form>
</div>

<script>
    let currentPerson = null;

    // ‚úÖ Helper to include JWT automatically in all requests
    async function jwtFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("Session expired or not logged in.");
            window.location.href = "login.html";
            return;
        }

        options.headers = {
            ...(options.headers || {}),
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
        };

        const response = await fetch(url, options);
        if (response.status === 403 || response.status === 401) {
            alert("Session expired or unauthorized. Please log in again.");
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }
        return response;
    }

    // ‚úÖ Ensure user is logged in before anything else
    async function ensureAuthenticated() {
        try {
            const res = await jwtFetch("/api/current-user");
            if (!res.ok) throw new Error("Unauthorized");
            const user = await res.json();
            currentPerson = user;
            console.log("Logged in as:", user.username);
            return user;
        } catch (err) {
            console.warn("Invalid or missing token");
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }
    }

    // ‚úÖ Load profile info
    async function loadProfile() {
        await ensureAuthenticated();
        if (!currentPerson) return;

        document.getElementById('email').value = currentPerson.email || '';
        document.getElementById('role').value = currentPerson.role || '';
        document.getElementById('firstName').value = currentPerson.firstName || '';
        document.getElementById('lastName').value = currentPerson.lastName || '';
        document.getElementById('password').value = '';
        updateVerificationButton();
    }

    // ‚úÖ Update profile
    async function updateProfile(personDTO) {
        const messageDiv = document.getElementById('updateMessage');
        messageDiv.textContent = '';
        messageDiv.className = '';

        try {
            const res = await jwtFetch('/api/updatePerson', {
                method: 'POST',
                body: JSON.stringify(personDTO)
            });

            if (res.ok) {
                messageDiv.textContent = '‚úÖ Profile updated successfully.';
                messageDiv.className = 'text-success';
                await loadProfile();
            } else if (res.status === 404) {
                messageDiv.textContent = '‚ùå User not found.';
                messageDiv.className = 'text-danger';
            } else {
                const errText = await res.text();
                messageDiv.textContent = '‚ùå Update failed: ' + errText;
                messageDiv.className = 'text-danger';
            }
        } catch (err) {
            console.error(err);
            messageDiv.textContent = '‚ùå Error updating profile.';
            messageDiv.className = 'text-danger';
        }
    }

    // ‚úÖ Verification button logic
    function updateVerificationButton() {
        const container = document.getElementById('verificationContainer');
        if (currentPerson.verified) {
            container.innerHTML = '<button type="button" class="btn btn-success w-100" disabled>‚úÖ Email Verified</button>';
        } else {
            container.innerHTML = `
        <button type="button" class="btn btn-warning w-100" id="sendVerificationBtn">
          üìß Send Verification Email
        </button>
        <div id="verificationMessage" class="mt-2"></div>
      `;

            document.getElementById('sendVerificationBtn').addEventListener('click', async () => {
                const messageDiv = document.getElementById('verificationMessage');
                messageDiv.textContent = '';

                try {
                    const res = await jwtFetch(`/api/sendEmail?userEmail=${currentPerson.email}`, { method: 'POST' });
                    if (res.ok) {
                        messageDiv.textContent = '‚úÖ Verification email sent! Please check your inbox.';
                        messageDiv.className = 'text-success';

                        // Poll for verification
                        const intervalId = setInterval(async () => {
                            const checkRes = await jwtFetch('/api/current-user');
                            if (checkRes.ok) {
                                const updatedUser = await checkRes.json();
                                if (updatedUser.verified) {
                                    currentPerson.verified = true;
                                    updateVerificationButton();
                                    clearInterval(intervalId);
                                    messageDiv.textContent = '‚úÖ Email verified!';
                                }
                            }
                        }, 2000);
                    } else {
                        const text = await res.text();
                        messageDiv.textContent = '‚ùå Failed to send email: ' + text;
                        messageDiv.className = 'text-danger';
                    }
                } catch (err) {
                    console.error(err);
                    messageDiv.textContent = '‚ùå Error sending verification email.';
                    messageDiv.className = 'text-danger';
                }
            });
        }
    }

    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', () => {
        const pwdInput = document.getElementById('password');
        pwdInput.type = pwdInput.type === 'password' ? 'text' : 'password';
    });

    // Load profile
    window.addEventListener('DOMContentLoaded', loadProfile);
</script>

</body>
</html>
