<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lecture Details | EduSmart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5faff; font-family: 'Segoe UI', sans-serif; }
        .btn-section { margin-top: 30px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 id="lecture-title" class="text-primary mb-4"></h1>
    <p id="lecture-content" class="lead"></p>

    <div class="btn-section" id="action-buttons"></div>
</div>

<script src="js/api.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const title = params.get("title");
        const index = params.get("index");
        if (!title || !index) return;

        const currentUser = getCurrentUser();
        const role = currentUser?.role;
        const userId = currentUser?.id;

        try {
            // Load lecture content
            const lecture = await apiFetch(`/getLectureByCourseTitleAndIndex?title=${encodeURIComponent(title)}&index=${index}`);
            document.getElementById("lecture-title").textContent = lecture?.title || `Lecture ${index}`;
            document.getElementById("lecture-content").textContent = lecture?.content || "No content available.";

            const actionDiv = document.getElementById("action-buttons");

            // Show "Mark Lecture as Read" only for enrolled STUDENT
            if (role === "STUDENT") {
                // Check if student is enrolled in this course
                const courseRes = await apiFetch(`/getCourseByTitle?title=${encodeURIComponent(title)}`);
                const courseId = courseRes?.id;

                if (courseId) {
                    const enrolledRes = await fetch(`/api/student/isEnrolledOnCourse/${userId}/${courseId}`, {
                        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                    });
                    const isEnrolled = enrolledRes.ok ? await enrolledRes.json() : false;

                    if (isEnrolled) {
                        // Check if lecture already read
                        const readRes = await fetch(`/api/student/isLectureRead/${userId}/${index}`, {
                            headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                        });
                        const isRead = readRes.ok ? await readRes.json() : false;

                        const statusMsg = document.createElement("div");
                        statusMsg.className = "mt-3";

                        if (isRead) {
                            statusMsg.textContent = "✅ Lecture already marked as read";
                            statusMsg.className = "text-success mt-3";
                            actionDiv.appendChild(statusMsg);
                        } else {
                            const markBtn = document.createElement("button");
                            markBtn.className = "btn btn-success";
                            markBtn.textContent = "Mark Lecture as Read";

                            markBtn.addEventListener("click", async () => {
                                try {
                                    const markRes = await fetch(`/api/student/markLectureAsRead/${userId}/${index}`, {
                                        method: "POST",
                                        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
                                    });
                                    const msg = await markRes.text();
                                    if (markRes.ok) {
                                        statusMsg.textContent = `✅ ${msg || "Lecture marked successfully."}`;
                                        statusMsg.className = "text-success mt-3";
                                        markBtn.disabled = true;
                                    } else {
                                        statusMsg.textContent = `❌ ${msg || "Failed to mark lecture."}`;
                                        statusMsg.className = "text-danger mt-3";
                                    }
                                } catch (err) {
                                    console.error(err);
                                    statusMsg.textContent = "❌ Network or server error.";
                                    statusMsg.className = "text-danger mt-3";
                                }
                            });

                            actionDiv.appendChild(markBtn);
                            actionDiv.appendChild(statusMsg);
                        }
                    }
                }
            }
        } catch (err) {
            console.error(err);
            document.body.innerHTML = `<div class='text-center text-danger mt-5'>Failed to load lecture.</div>`;
        }
    });
</script>

</body>
</html>
